<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoomRTC - Video Conference</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #202124;
            color: #e8eaed;
            height: 100vh;
            overflow: hidden;
        }

        .meeting-container {
            display: flex;
            height: 100vh;
            background: #202124;
        }

        /* Main Content Area (Left) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #202124;
            position: relative;
        }

        .video-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            padding: 8px;
            background: #202124;
        }

        .video-container {
            position: relative;
            background: #3c4043;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            min-height: 120px;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .video-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .video-control-btn {
            background: rgba(0,0,0,0.6);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        #localVideo {
            transform: scaleX(-1); /* Mirror effect */
        }

        /* Fix screen share rotation - no mirror effect for screen share */
        .screen-share video {
            transform: none !important;
        }

        /* Screen share container styles */
        .screen-share-container {
            border: 2px solid #1a73e8;
            box-shadow: 0 0 20px rgba(26, 115, 232, 0.3);
        }

        .screen-share-container .video-label {
            background: rgba(26, 115, 232, 0.9) !important;
            font-weight: 600;
        }

        /* Participants Panel (Right) */
        .participants-panel {
            width: 300px;
            background: #2d2e30;
            border-left: 1px solid #3c4043;
            display: flex;
            flex-direction: column;
        }

        .participants-header {
            padding: 16px;
            border-bottom: 1px solid #3c4043;
            font-size: 16px;
            font-weight: 500;
            color: #e8eaed;
        }

        .participants-list {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            background: #3c4043;
        }

        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5f6368;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 14px;
            margin-right: 12px;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 500;
            color: #e8eaed;
        }

        .participant-status {
            font-size: 12px;
            color: #9aa0a6;
        }

        .participant-controls {
            display: flex;
            gap: 4px;
        }

        .participant-control-btn {
            background: none;
            border: none;
            color: #9aa0a6;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        .participant-control-btn.muted {
            color: #ea4335;
        }

        /* Bottom Control Bar */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2e30;
            border-top: 1px solid #3c4043;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .control-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .meeting-info {
            display: flex;
            flex-direction: column;
        }

        .meeting-time {
            font-size: 14px;
            color: #e8eaed;
        }

        .meeting-code {
            font-size: 12px;
            color: #9aa0a6;
        }

        .control-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn {
            background: #3c4043;
            border: none;
            color: #e8eaed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .control-btn:hover {
            background: #5f6368;
        }

        .control-btn.active {
            background: #1a73e8;
        }

        .control-btn.danger {
            background: #ea4335;
        }

        .control-btn.danger:hover {
            background: #d33b2c;
        }

        .control-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn.small {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }

        /* Join Section */
        .join-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2e30;
            border: 1px solid #3c4043;
            border-radius: 12px;
            padding: 32px;
            width: 400px;
            max-width: 90vw;
            z-index: 1001;
        }

        .join-section h2 {
            color: #e8eaed;
            margin-bottom: 24px;
            text-align: center;
            font-size: 24px;
            font-weight: 400;
        }

        .join-section input {
            width: 100%;
            padding: 12px 16px;
            margin: 8px 0;
            background: #3c4043;
            border: 1px solid #5f6368;
            border-radius: 8px;
            color: #e8eaed;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .join-section input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .join-section input::placeholder {
            color: #9aa0a6;
        }

        .join-section .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .join-section .btn:hover {
            background: #1557b0;
        }

        .join-section .btn:disabled {
            background: #5f6368;
            cursor: not-allowed;
        }

        .join-section .btn-secondary {
            background: #3c4043;
        }

        .join-section .btn-secondary:hover {
            background: #5f6368;
        }

        .join-section .btn-success {
            background: #34a853;
        }

        .join-section .btn-success:hover {
            background: #2d8f47;
        }

        .join-section .btn-info {
            background: #1a73e8;
        }

        .join-section .btn-info:hover {
            background: #1557b0;
        }

        /* Status Messages */
        .status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2e30;
            color: #e8eaed;
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid #3c4043;
            font-size: 14px;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status.show {
            opacity: 1;
        }

        .status.connected {
            background: #1e3a2e;
            border-color: #34a853;
            color: #34a853;
        }

        .status.disconnected {
            background: #3c1a1a;
            border-color: #ea4335;
            color: #ea4335;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .participants-panel {
                width: 250px;
            }
            
            .join-section {
                width: 350px;
                padding: 24px;
            }
            
            .control-bar {
                padding: 8px 12px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .participants-panel {
                display: none;
            }
            
            .join-section {
                width: 320px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Join Section -->
    <div class="join-section" id="joinSection">
        <h2>Join Meeting</h2>
        <input type="text" id="userIdInput" placeholder="Your Name" value="">
        <input type="text" id="roomIdInput" placeholder="Room ID (e.g., 123)" value="">
        <button class="btn" id="joinBtn" onclick="joinRoom()">Join</button>
        <button class="btn btn-secondary hidden" id="leaveBtn" onclick="leaveRoom()">Leave</button>
        <button class="btn btn-info hidden" id="copyUrlBtn" onclick="copyRoomUrl()">üìã Copy Room URL</button>
    </div>

    <!-- Meeting Container -->
    <div class="meeting-container hidden" id="meetingContainer">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="video-grid" id="videoGrid">
                <div class="video-container">
                    <video id="localVideo" autoplay muted></video>
                    <div class="video-label">You</div>
                    <div class="video-controls">
                        <button class="video-control-btn" id="localVideoBtn" onclick="toggleVideo()">üìπ</button>
                        <button class="video-control-btn" id="localAudioBtn" onclick="toggleAudio()">üé§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participants Panel -->
        <div class="participants-panel">
            <div class="participants-header">
                People (<span id="participantCount">1</span>)
            </div>
            <div class="participants-list" id="participantsList">
                <div class="participant-item">
                    <div class="participant-avatar" id="localAvatar">Y</div>
                    <div class="participant-info">
                        <div class="participant-name" id="localName">You</div>
                        <div class="participant-status">Connected</div>
                    </div>
                    <div class="participant-controls">
                        <button class="participant-control-btn" id="localMuteBtn">üé§</button>
                        <button class="participant-control-btn" id="localVideoBtn2">üìπ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Control Bar -->
    <div class="control-bar hidden" id="controlBar">
        <div class="control-left">
            <div class="meeting-info">
                <div class="meeting-time" id="meetingTime">10:57 AM</div>
                <div class="meeting-code" id="meetingCode">Room: <span id="roomCode">123</span></div>
            </div>
        </div>
        
        <div class="control-center">
            <button class="control-btn" id="audioBtn" onclick="toggleAudio()" title="Turn off microphone">
                üé§
            </button>
            <button class="control-btn" id="videoBtn" onclick="toggleVideo()" title="Turn off camera">
                üìπ
            </button>
            <button class="control-btn" id="shareBtn" onclick="toggleScreenShare()" title="Present now">
                üñ•Ô∏è
            </button>
            <button class="control-btn" id="leaveBtn2" onclick="leaveRoom()" title="Leave call">
                üìû
            </button>
        </div>
        
        <div class="control-right">
            <button class="control-btn small" id="copyUrlBtn2" onclick="copyRoomUrl()" title="Copy meeting link">
                üîó
            </button>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status" id="status"></div>

    <script>
        // Global variables
        let ws = null;
        const peers = new Map();
        const remoteStreams = new Map();
        let localStream = null;
        let currentRoomId = null;
        let currentUserId = null;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let isScreenSharing = false;
        let appConfig = null;
        let currentRoomUrl = '';
        let serverInfo = null;
        let meetingStartTime = null;

        // Load configuration from config.json file
        async function loadConfig() {
            try {
                const response = await fetch('./config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                appConfig = await response.json();
            } catch (error) {
                console.error('Error loading config.json:', error);
                // Fallback configuration
                appConfig = {
                    client: {
                        serverUrl: 'https://localhost:5000',
                        wsUrl: 'wss://localhost:5000',
                        autoReconnectDelay: 5000,
                        connectionTimeout: 10000
                    },
                    webrtc: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                };
            }
        }

        // Load server info (IP address)
        async function loadServerInfo() {
            try {
                const response = await fetch('/ip');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                serverInfo = await response.json();
            } catch (error) {
                console.error('Error loading server info:', error);
                // Fallback to current location
                serverInfo = {
                    ip: window.location.hostname,
                    port: window.location.port || '5000',
                    url: window.location.origin
                };
            }
        }

        // Get ICE servers from configuration
        function getIceServers() {
            if (appConfig && appConfig.webrtc && appConfig.webrtc.iceServers) {
                return appConfig.webrtc.iceServers;
            }
            return [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ];
        }

        // Get WebSocket URL
        function getWebSocketURL() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            return `${protocol}//${host}`;
        }

        // Auto-fill room ID from URL hash
        window.addEventListener('load', async () => {
            // Load configuration and server info first
            await loadConfig();
            await loadServerInfo();
            
            const hash = window.location.hash.substring(1);
            if (hash) {
                document.getElementById('roomIdInput').value = hash;
            }
            
            // Generate random user ID if empty
            if (!document.getElementById('userIdInput').value) {
                document.getElementById('userIdInput').value = 'User-' + Math.floor(Math.random() * 1000);
            }
            
            // Client s·∫Ω ch·ªâ join room khi user b·∫•m n√∫t "Join" manual
            
            // Check if accessing via IP instead of localhost
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            const isHttps = window.location.protocol === 'https:';
            
            if (!isLocalhost && !isHttps) {
                // Show warning about media access
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning';
                warningDiv.style.margin = '10px 0';
                warningDiv.style.padding = '10px';
                warningDiv.style.backgroundColor = '#fff3cd';
                warningDiv.style.border = '1px solid #ffeaa7';
                warningDiv.style.borderRadius = '4px';
                warningDiv.style.color = '#856404';
                warningDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Media Access Notice:</strong> 
                    You're accessing via IP address (${window.location.hostname}). 
                    For camera/microphone access, please use HTTPS or access via localhost.
                    <br><small>Current URL: ${window.location.href}</small>
                `;
                
                const joinSection = document.querySelector('.join-section');
                joinSection.insertBefore(warningDiv, joinSection.firstChild);
            }

            // Connect WebSocket
            connectWebSocket();
        });

        // WebSocket connection
        function connectWebSocket() {
            const wsUrl = getWebSocketURL();
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateStatus('Connected to server', 'connected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus('Disconnected from server', 'disconnected');
                
                // N·∫øu ƒëang trong room, t·ª± ƒë·ªông out room v√† quay v·ªÅ trang ch·ªß
                if (currentRoomId && currentUserId) {
                    console.log('Server disconnected, leaving room and returning to home');
                    leaveRoom();
                    // Quay v·ªÅ trang ch·ªß
                    window.location.href = '/';
                    return;
                }
                
                // Auto-reconnect ch·ªâ khi kh√¥ng trong room
                setTimeout(() => {
                    console.log('Attempting to reconnect...');
                    connectWebSocket();
                }, appConfig?.client?.autoReconnectDelay || 5000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Connection error', 'disconnected');
            };
        }

        // Send message to server
        function sendMessage(type, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, data }));
            }
        }

        // Handle incoming messages
        function handleMessage(message) {
            const { type, data } = message;
            
            switch (type) {
                case 'user-joined':
                    handleUserJoined(data.userId);
                    break;
                case 'user-left':
                    handleUserLeft(data.userId);
                    break;
                case 'existing-users':
                    handleExistingUsers(data.users);
                    break;
                case 'offer':
                    handleOffer(data.offer, data.fromUserId, data.targetUserId);
                    break;
                case 'answer':
                    handleAnswer(data.answer, data.fromUserId, data.targetUserId);
                    break;
                case 'ice-candidate':
                    handleIceCandidate(data.candidate, data.fromUserId, data.targetUserId);
                    break;
            }
        }

        // Handle user joined
        async function handleUserJoined(userId) {
            addParticipant(userId);
            updateParticipantCount();
            
            // Create peer connection and send offer to the new user
            if (localStream) {
                try {
                    const peer = await createPeerConnection(userId);
                    
                    const offer = await peer.createOffer();
                    await peer.setLocalDescription(offer);
                    sendMessage('offer', { offer, targetUserId: userId });
                } catch (error) {
                    console.error('Error creating offer for new user:', error);
                }
            }
        }

        // Handle user left
        function handleUserLeft(userId) {
            removeParticipant(userId);
            removePeer(userId);
            updateParticipantCount();
        }

        // Handle existing users
        async function handleExistingUsers(users) {
            users.forEach(userId => {
                if (userId !== currentUserId) {
                    addParticipant(userId);
                } else {
                    console.log('üîç Skipping self:', userId);
                }
            });
            updateParticipantCount();
            
            // Create peer connections and send offers to all existing users
            if (localStream) {
                for (const userId of users) {
                    if (userId !== currentUserId) {
                        try {
                            const peer = await createPeerConnection(userId);
                            
                            const offer = await peer.createOffer();
                            await peer.setLocalDescription(offer);
                            sendMessage('offer', { offer, targetUserId: userId });
                        } catch (error) {
                            console.error('Error creating offer for existing user:', error);
                        }
                    }
                }
            }
        }

        // Handle offer
        async function handleOffer(offer, fromUserId, targetUserId) {
            if (targetUserId === currentUserId) {
                const peer = await createPeerConnection(fromUserId);
                await peer.setRemoteDescription(offer);
                
                // Note: tracks are already added in createPeerConnection
                // No need to add them again here
                
                const answer = await peer.createAnswer();
                await peer.setLocalDescription(answer);
                sendMessage('answer', { answer, targetUserId: fromUserId });
            }
        }

        // Handle answer
        async function handleAnswer(answer, fromUserId, targetUserId) {
            if (targetUserId === currentUserId) {
                const peer = peers.get(fromUserId);
                if (peer) {
                    await peer.setRemoteDescription(answer);
                }
            }
        }

        // Handle ICE candidate
        async function handleIceCandidate(candidate, fromUserId, targetUserId) {
            if (targetUserId === currentUserId) {
                const peer = peers.get(fromUserId);
                if (peer) {
                    await peer.addIceCandidate(candidate);
                }
            }
        }

        // Check if media devices are available
        function isMediaDevicesSupported() {
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }

        // Check camera availability
        async function checkCameraAvailability() {
            if (!isMediaDevicesSupported()) {
                console.warn('MediaDevices API not supported');
                return false;
            }
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                return videoDevices.length > 0;
            } catch (error) {
                console.error('Error checking camera availability:', error);
                return false;
            }
        }

        // Get user media with fallback
        async function getUserMediaWithFallback(constraints) {
            if (!isMediaDevicesSupported()) {
                throw new Error('MediaDevices API not supported. Please use HTTPS or localhost.');
            }

            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (error) {
                console.error('Error accessing media devices:', error);
                
                // Check if it's a security error (HTTPS required)
                if (error.name === 'NotAllowedError' || error.name === 'NotSupportedError') {
                    const isLocalhost = window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1';
                    const isHttps = window.location.protocol === 'https:';
                    
                    if (!isLocalhost && !isHttps) {
                        throw new Error('Media access requires HTTPS when accessing via IP address. Please use HTTPS or access via localhost.');
                    }
                }
                
                throw error;
            }
        }

        // Main functions
        async function joinRoom() {
            const roomId = document.getElementById('roomIdInput').value.trim();
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!roomId || !userId) {
                alert('Please enter both Room ID and Your Name');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server. Please wait...');
                return;
            }

            try {
                // Check if media devices are supported
                if (!isMediaDevicesSupported()) {
                    // Ask user if they want to join without media
                    const joinWithoutMedia = confirm(
                        'MediaDevices API not supported. This might be because you\'re accessing via IP address.\n\n' +
                        'Would you like to join the room without camera/microphone? (You can still see others but won\'t be able to share your media)'
                    );
                    
                    if (!joinWithoutMedia) {
                        throw new Error('Media access required to join room.');
                    }
                    
                    // Join without media
                    localStream = null;
                    isVideoEnabled = false;
                    isAudioEnabled = false;
                } else {
                    // Get user media - only audio required, video optional
                    try {
                        localStream = await getUserMediaWithFallback({ 
                            video: false, 
                            audio: true 
                        });
                        
                        // Check if camera is available and add video track if needed
                        const hasCamera = await checkCameraAvailability();
                        if (hasCamera) {
                            try {
                                const videoStream = await getUserMediaWithFallback({ 
                                    video: true, 
                                    audio: false 
                                });
                                const videoTrack = videoStream.getVideoTracks()[0];
                                if (videoTrack) {
                                    localStream.addTrack(videoTrack);
                                    isVideoEnabled = true;
                                }
                            } catch (videoError) {
                                console.warn('Could not access camera:', videoError);
                                isVideoEnabled = false;
                            }
                        } else {
                            isVideoEnabled = false;
                        }
                    } catch (mediaError) {
                        console.error('Error accessing media:', mediaError);
                        
                        // Ask user if they want to join without media
                        const joinWithoutMedia = confirm(
                            'Could not access camera/microphone. This might be because you\'re accessing via IP address.\n\n' +
                            'Would you like to join the room without camera/microphone? (You can still see others but won\'t be able to share your media)'
                        );
                        
                        if (!joinWithoutMedia) {
                            throw mediaError;
                        }
                        
                        // Join without media
                        localStream = null;
                        isVideoEnabled = false;
                        isAudioEnabled = false;
                    }
                }
                
                // Set local video source (might be null if no media access)
                document.getElementById('localVideo').srcObject = localStream;
                
                // Update UI based on media availability
                if (!localStream) {
                    // Hide local video if no media
                    document.getElementById('localVideo').style.display = 'none';
                    document.getElementById('videoBtn').disabled = true;
                    document.getElementById('audioBtn').disabled = true;
                    document.getElementById('shareBtn').disabled = true;
                } else {
                    document.getElementById('localVideo').style.display = 'block';
                }
                
                currentRoomId = roomId;
                currentUserId = userId;
                
                // Update URL hash
                window.location.hash = roomId;
                
                // Generate room URL for sharing using server IP
                if (serverInfo && serverInfo.url) {
                    currentRoomUrl = `${serverInfo.url}#${roomId}`;
                } else {
                    currentRoomUrl = `${window.location.origin}${window.location.pathname}#${roomId}`;
                }
                
                sendMessage('join-room', { roomId, userId });
                
                // Show meeting interface
                document.getElementById('joinSection').classList.add('hidden');
                document.getElementById('meetingContainer').classList.remove('hidden');
                document.getElementById('controlBar').classList.remove('hidden');
                
                // Update meeting info
                document.getElementById('roomCode').textContent = roomId;
                document.getElementById('localName').textContent = userId;
                document.getElementById('localAvatar').textContent = userId.charAt(0).toUpperCase();
                
                // Start meeting timer
                meetingStartTime = new Date();
                updateMeetingTime();
                setInterval(updateMeetingTime, 1000);
                
                // Update camera button based on availability
                updateCameraButton();
                
                updateStatus(`Joined room: ${roomId} as ${userId}`, 'connected');
                
            } catch (error) {
                console.error('Error accessing media:', error);
                alert('Error accessing camera/microphone: ' + error.message);
            }
        }

        function leaveRoom() {
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Close all peer connections
            peers.forEach((peer, userId) => {
                peer.close();
                removePeer(userId);
            });
            peers.clear();
            
            currentRoomId = null;
            currentUserId = null;
            
            // Show join interface
            document.getElementById('joinSection').classList.remove('hidden');
            document.getElementById('meetingContainer').classList.add('hidden');
            document.getElementById('controlBar').classList.add('hidden');
            
            // Clear participants
            document.getElementById('participantsList').innerHTML = `
                <div class="participant-item">
                    <div class="participant-avatar" id="localAvatar">Y</div>
                    <div class="participant-info">
                        <div class="participant-name" id="localName">You</div>
                        <div class="participant-status">Connected</div>
                    </div>
                    <div class="participant-controls">
                        <button class="participant-control-btn" id="localMuteBtn">üé§</button>
                        <button class="participant-control-btn" id="localVideoBtn2">üìπ</button>
                    </div>
                </div>
            `;
            
            updateParticipantCount();
            updateStatus('Left room', 'disconnected');
        }

        // Create peer connection
        async function createPeerConnection(userId) {
            const peer = new RTCPeerConnection({
                iceServers: getIceServers()
            });
            
            peer.onicecandidate = (event) => {
                if (event.candidate) {
                    sendMessage('ice-candidate', {
                        candidate: event.candidate,
                        targetUserId: userId
                    });
                }
            };
            
            // Handle negotiation needed for new tracks (screen share)
            peer.onnegotiationneeded = async () => {
                try {
                    const offer = await peer.createOffer();
                    await peer.setLocalDescription(offer);
                    sendMessage('offer', { offer, targetUserId: userId });
                } catch (error) {
                    console.error('Error during negotiation:', error);
                }
            };
            
            peer.ontrack = (event) => {
                const remoteStream = event.streams[0];
                const track = event.track;
                
                // Check if this is a screen share track
                if (track.kind === 'video' && track.label.includes('screen')) {
                    addRemoteScreenShare(userId, remoteStream);
                } else {
                    remoteStreams.set(userId, remoteStream);
                    addRemoteVideo(userId, remoteStream);
                }
            };
            
            // Add local stream tracks to the new peer connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peer.addTrack(track, localStream);
                });
            }
            
            peers.set(userId, peer);
            return peer;
        }

        // Remove peer connection
        function removePeer(userId) {
            const peer = peers.get(userId);
            if (peer) {
                peer.close();
                peers.delete(userId);
            }
            remoteStreams.delete(userId);
            removeRemoteVideo(userId);
        }

        // Add remote video
        function addRemoteVideo(userId, stream) {
            const videoGrid = document.getElementById('videoGrid');
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.id = `video-${userId}`;
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = userId;
            
            videoContainer.appendChild(video);
            videoContainer.appendChild(label);
            videoGrid.appendChild(videoContainer);
        }

        // Add remote screen share
        function addRemoteScreenShare(userId, stream) {
            const videoGrid = document.getElementById('videoGrid');
            
            // Remove existing screen share for this user if any
            const existingScreenShare = document.getElementById(`screen-share-${userId}`);
            if (existingScreenShare) {
                existingScreenShare.remove();
            }
            
            const screenShareContainer = document.createElement('div');
            screenShareContainer.className = 'video-container screen-share-container';
            screenShareContainer.id = `screen-share-${userId}`;
            screenShareContainer.style.gridColumn = '1 / -1'; // Take full width
            screenShareContainer.style.maxHeight = '60vh';
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.style.objectFit = 'contain';
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = `${userId} is sharing screen`;
            label.style.background = 'rgba(26, 115, 232, 0.9)';
            
            screenShareContainer.appendChild(video);
            screenShareContainer.appendChild(label);
            
            // Insert at the beginning of video grid
            videoGrid.insertBefore(screenShareContainer, videoGrid.firstChild);
        }

        // Remove remote video
        function removeRemoteVideo(userId) {
            const videoContainer = document.getElementById(`video-${userId}`);
            if (videoContainer) {
                videoContainer.remove();
            }
            
            // Also remove screen share if exists
            const screenShareContainer = document.getElementById(`screen-share-${userId}`);
            if (screenShareContainer) {
                screenShareContainer.remove();
            }
        }

        // Add participant to list
        function addParticipant(userId) {
            const participantsList = document.getElementById('participantsList');
            const participantItem = document.createElement('div');
            participantItem.className = 'participant-item';
            participantItem.id = `participant-${userId}`;
            
            participantItem.innerHTML = `
                <div class="participant-avatar">${userId.charAt(0).toUpperCase()}</div>
                <div class="participant-info">
                    <div class="participant-name">${userId}</div>
                    <div class="participant-status">Connected</div>
                </div>
                <div class="participant-controls">
                    <button class="participant-control-btn">üé§</button>
                    <button class="participant-control-btn">üìπ</button>
                </div>
            `;
            
            participantsList.appendChild(participantItem);
        }

        // Remove participant from list
        function removeParticipant(userId) {
            const participantItem = document.getElementById(`participant-${userId}`);
            if (participantItem) {
                participantItem.remove();
            }
        }

        // Update participant count
        function updateParticipantCount() {
            const count = document.querySelectorAll('.participant-item').length;
            document.getElementById('participantCount').textContent = count;
        }

        // Update meeting time
        function updateMeetingTime() {
            if (meetingStartTime) {
                const now = new Date();
                const diff = now - meetingStartTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                document.getElementById('meetingTime').textContent = timeStr;
            }
        }

        // Update camera button based on availability
        function updateCameraButton() {
            const videoBtn = document.getElementById('videoBtn');
            const videoTrack = localStream ? localStream.getVideoTracks()[0] : null;
            
            if (!videoTrack) {
                // No camera available
                videoBtn.disabled = true;
                videoBtn.textContent = 'üìπ';
                videoBtn.className = 'control-btn';
                videoBtn.title = 'No camera detected';
            } else {
                // Camera available
                videoBtn.disabled = false;
                videoBtn.title = 'Turn off camera';
                if (isVideoEnabled) {
                    videoBtn.textContent = 'üìπ';
                    videoBtn.className = 'control-btn active';
                } else {
                    videoBtn.textContent = 'üìπ';
                    videoBtn.className = 'control-btn';
                }
            }
        }

        function toggleVideo() {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                isVideoEnabled = videoTrack.enabled;
                updateCameraButton();
                
                // Update all peer connections
                peers.forEach(async (peer) => {
                    const sender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }
                });
            }
        }

        function toggleAudio() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isAudioEnabled = audioTrack.enabled;
                
                const audioBtn = document.getElementById('audioBtn');
                if (isAudioEnabled) {
                    audioBtn.textContent = 'üé§';
                    audioBtn.className = 'control-btn active';
                    audioBtn.title = 'Turn off microphone';
                } else {
                    audioBtn.textContent = 'üé§';
                    audioBtn.className = 'control-btn';
                    audioBtn.title = 'Turn on microphone';
                }
                
                // Update all peer connections
                peers.forEach(async (peer) => {
                    const sender = peer.getSenders().find(s => s.track && s.track.kind === 'audio');
                    if (sender) {
                        await sender.replaceTrack(audioTrack);
                    }
                });
            }
        }

        async function toggleScreenShare() {
            if (!localStream) return;

            try {
                if (!isScreenSharing) {
                    // Start screen sharing
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true,
                        audio: true 
                    });
                    
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const audioTrack = screenStream.getAudioTracks()[0];
                    
                    // Store the old video track for later restoration
                    const oldVideoTrack = localStream.getVideoTracks()[0];
                    
                    // Replace video track in local stream
                    if (oldVideoTrack) {
                        localStream.removeTrack(oldVideoTrack);
                        oldVideoTrack.stop();
                    }
                    localStream.addTrack(videoTrack);
                    
                    // Add audio track if available
                    if (audioTrack) {
                        localStream.addTrack(audioTrack);
                    }
                    
                    // Update local video
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                    localVideo.parentElement.classList.add('screen-share');
                    
                    // Update all peer connections with the new tracks
                    for (const [userId, peer] of peers) {
                        try {
                            const videoSender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                            const audioSender = peer.getSenders().find(s => s.track && s.track.kind === 'audio');
                            
                            if (videoSender) {
                                await videoSender.replaceTrack(videoTrack);
                            } else {
                                peer.addTrack(videoTrack, localStream);
                            }
                            
                            if (audioTrack && audioSender) {
                                await audioSender.replaceTrack(audioTrack);
                            } else if (audioTrack) {
                                peer.addTrack(audioTrack, localStream);
                            }
                        } catch (peerError) {
                            // Handle peer connection error silently
                        }
                    }
                    
                    isScreenSharing = true;
                    document.getElementById('shareBtn').textContent = 'üñ•Ô∏è';
                    document.getElementById('shareBtn').className = 'control-btn active';
                    document.getElementById('shareBtn').title = 'Stop presenting';
                    
                    // Handle screen share end
                    videoTrack.onended = () => {
                        stopScreenShare();
                    };
                    
                } else {
                    stopScreenShare();
                }
            } catch (error) {
                console.error('Error with screen sharing:', error);
                alert('Screen sharing error: ' + error.message);
            }
        }

        async function stopScreenShare() {
            try {
                // Remove the current video track (screen share)
                const oldVideoTrack = localStream.getVideoTracks()[0];
                if (oldVideoTrack) {
                    localStream.removeTrack(oldVideoTrack);
                    oldVideoTrack.stop();
                }
                
                // Remove screen share audio track if exists
                const screenAudioTracks = localStream.getAudioTracks().filter(track => 
                    track.label.includes('screen') || track.label.includes('display')
                );
                screenAudioTracks.forEach(track => {
                    localStream.removeTrack(track);
                    track.stop();
                });
                
                // Try to get camera back if available
                const hasCamera = await checkCameraAvailability();
                let newVideoTrack = null;
                
                if (hasCamera) {
                    try {
                        const cameraStream = await getUserMediaWithFallback({ 
                            video: true, 
                            audio: false 
                        });
                        newVideoTrack = cameraStream.getVideoTracks()[0];
                        localStream.addTrack(newVideoTrack);
                        isVideoEnabled = true;
                    } catch (cameraError) {
                        isVideoEnabled = false;
                    }
                } else {
                    isVideoEnabled = false;
                }
                
                // Update local video
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                localVideo.parentElement.classList.remove('screen-share');
                
                // Update all peer connections with the new video track (or remove video if no camera)
                for (const [userId, peer] of peers) {
                    try {
                        const videoSender = peer.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (videoSender) {
                            if (newVideoTrack) {
                                await videoSender.replaceTrack(newVideoTrack);
                            } else {
                                await videoSender.replaceTrack(null);
                            }
                        } else if (newVideoTrack) {
                            peer.addTrack(newVideoTrack, localStream);
                        }
                    } catch (peerError) {
                        // Handle peer connection error silently
                    }
                }
                
                isScreenSharing = false;
                document.getElementById('shareBtn').textContent = 'üñ•Ô∏è';
                document.getElementById('shareBtn').className = 'control-btn';
                document.getElementById('shareBtn').title = 'Present now';
                
                // Update camera button
                updateCameraButton();
                
            } catch (error) {
                console.error('Error stopping screen share:', error);
            }
        }

        // Copy room URL to clipboard
        async function copyRoomUrl() {
            try {
                await navigator.clipboard.writeText(currentRoomUrl);
                updateStatus('Room URL copied to clipboard!', 'connected');
                
                // Show temporary success message
                const copyBtn = document.getElementById('copyUrlBtn');
                const copyBtn2 = document.getElementById('copyUrlBtn2');
                const originalText = copyBtn.textContent;
                const originalText2 = copyBtn2.textContent;
                
                copyBtn.textContent = '‚úÖ Copied!';
                copyBtn.className = 'btn btn-success';
                copyBtn2.textContent = '‚úÖ';
                copyBtn2.className = 'control-btn small active';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.className = 'btn btn-info';
                    copyBtn2.textContent = 'üîó';
                    copyBtn2.className = 'control-btn small';
                }, 2000);
                
            } catch (error) {
                console.error('Failed to copy URL:', error);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentRoomUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                updateStatus('Room URL copied to clipboard!', 'connected');
            }
        }

        // Update status message
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status show ${type}`;
            
            setTimeout(() => {
                status.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>